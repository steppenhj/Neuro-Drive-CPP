<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro-Drive Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            overflow: hidden; /* 스크롤 방지 */
            touch-action: none; /* 터치 확대/축소 방지 */
        }
        #zone_joystick {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%); /* 정중앙 배치 */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="debug">Ready...</div>
    <div id="zone_joystick"></div>

    <script>
        // 1. 조이스틱 생성
        var options = {
            zone: document.getElementById('zone_joystick'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: 'white',
            size: 150
        };
        var manager = nipplejs.create(options);

        // 2. 쓰로틀링을 위한 변수 (과도한 요청 방지)
        let lastSentTime = 0;
        const SEND_INTERVAL = 100; // 0.1초마다 전송

        // 3. 조이스틱 움직임 이벤트 감지
        manager.on('move', function (evt, data) {
            const now = Date.now();
            if (now - lastSentTime > SEND_INTERVAL) {
                // 데이터 추출 (vector: {x: -1~1, y: -1~1})
                if (data.vector) {
                    sendJoystickData(data.vector.x, data.vector.y);
                    lastSentTime = now;
                }
            }
        });

        // 4. 조이스틱 놓았을 때 (정지)
        manager.on('end', function () {
            sendJoystickData(0, 0); // (0,0) 전송하여 정지
        });

        function sendJoystickData(x, y) {
            // 화면에 디버그 정보 표시
            document.getElementById('debug').innerText = 
                `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;

            fetch('/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ x: x, y: y })
            }).catch(console.error);
        }
    </script>
</body>
</html>